# SillyTavern + Telegram Bot é›†æˆæ¶æ„æŒ‡å—

> **æ–‡æ¡£ç‰ˆæœ¬**: 1.0
> **åˆ›å»ºæ—¥æœŸ**: 2026-01-01
> **ç›®æ ‡å—ä¼—**: å¼€å‘è€…ã€ç³»ç»Ÿæ¶æ„å¸ˆ
> **æŠ€æœ¯æ ˆ**: SillyTavern (Node.js) + Python-Telegram-Bot + Docker

---

## ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
3. [æŠ€æœ¯æ ˆè¯¦è§£](#æŠ€æœ¯æ ˆè¯¦è§£)
4. [å®ç°æ–¹æ¡ˆ](#å®ç°æ–¹æ¡ˆ)
5. [Docker éƒ¨ç½²](#docker-éƒ¨ç½²)
6. [API æ¥å£è®¾è®¡](#api-æ¥å£è®¾è®¡)
7. [ä»£ç ç¤ºä¾‹](#ä»£ç ç¤ºä¾‹)
8. [éƒ¨ç½²æµç¨‹](#éƒ¨ç½²æµç¨‹)
9. [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)
10. [å‚è€ƒèµ„æ–™](#å‚è€ƒèµ„æ–™)

---

## æ¦‚è¿°

### é¡¹ç›®ç›®æ ‡

æ„å»ºä¸€ä¸ªå®Œæ•´çš„é›†æˆç³»ç»Ÿï¼Œå…è®¸ç”¨æˆ·é€šè¿‡ Telegram Bot **åŒå‘æ§åˆ¶** SillyTavernï¼Œå®ç°ï¼š
- èŠå¤©å¯¹è¯ï¼ˆå‘é€æ¶ˆæ¯ã€æ¥æ”¶ AI å›å¤ï¼‰
- è§’è‰²ç®¡ç†ï¼ˆåˆ›å»ºã€ç¼–è¾‘ã€åˆ‡æ¢è§’è‰²ï¼‰
- å†å²è®°å½•ç®¡ç†
- é…ç½®ç®¡ç†ï¼ˆAPI å¯†é’¥ã€æ¨¡å‹é€‰æ‹©ç­‰ï¼‰

### æ ¸å¿ƒç‰¹æ€§

| ç‰¹æ€§ | æè¿° | ä¼˜å…ˆçº§ |
|------|------|--------|
| åŒå‘é€šä¿¡ | Telegram â†” SillyTavern å®æ—¶æ¶ˆæ¯åŒæ­¥ | é«˜ |
| è§’è‰²æ§åˆ¶ | é€šè¿‡ Telegram åˆ‡æ¢å’Œç®¡ç†è§’è‰² | é«˜ |
| é…ç½®ç®¡ç† | è¿œç¨‹ä¿®æ”¹ SillyTavern è®¾ç½® | ä¸­ |
| å†å²è®°å½• | æŸ¥çœ‹å’Œç®¡ç†èŠå¤©å†å² | ä¸­ |
| æ–‡ä»¶æ”¯æŒ | å‘é€å›¾ç‰‡ã€æ–‡æ¡£ç­‰ | ä½ |

---

## æ¶æ„è®¾è®¡

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         äº‘æœåŠ¡å™¨                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  SillyTavern     â”‚         â”‚  Telegram Bot    â”‚              â”‚
â”‚  â”‚  (Node.js)       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”¤  (Python)        â”‚              â”‚
â”‚  â”‚  Port: 8000      â”‚  HTTP   â”‚  Port: 8443      â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚           â”‚                            â”‚                         â”‚
â”‚           â”‚                            â”‚                         â”‚
â”‚           â–¼                            â–¼                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  æ•°æ®ç›®å½•        â”‚         â”‚  ä¼šè¯çŠ¶æ€        â”‚              â”‚
â”‚  â”‚  /data           â”‚         â”‚  (Redis/å†…å­˜)    â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ HTTPS/Webhook
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Telegram æœåŠ¡å™¨                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ ç”¨æˆ·äº¤äº’
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Telegram å®¢æˆ·ç«¯                               â”‚
â”‚                    (æ‰‹æœº/æ¡Œé¢/Web)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµå›¾

```
ç”¨æˆ·å‘é€æ¶ˆæ¯ (Telegram)
        â”‚
        â–¼
Telegram Bot æ¥æ”¶ (Webhook)
        â”‚
        â”œâ”€â–º è½¬å‘åˆ° SillyTavern API (POST /api/chat)
        â”‚
        â–¼
SillyTavern å¤„ç†æ¶ˆæ¯
        â”‚
        â”œâ”€â–º è°ƒç”¨ LLM API (OpenAI/Claude/ç­‰)
        â”‚
        â–¼
AI ç”Ÿæˆå›å¤
        â”‚
        â–¼
SillyTavern è¿”å›ç»“æœ
        â”‚
        â–¼
Telegram Bot å‘é€å›å¤ç»™ç”¨æˆ·
```

---

## æŠ€æœ¯æ ˆè¯¦è§£

### SillyTavern

**åŸºæœ¬ä¿¡æ¯**:
- **ç±»å‹**: æœ¬åœ° LLM å‰ç«¯ç•Œé¢
- **è¯­è¨€**: JavaScript/Node.js
- **ç«¯å£**: é»˜è®¤ 8000
- **GitHub**: https://github.com/SillyTavern/SillyTavern

**æ ¸å¿ƒåŠŸèƒ½**:
- ç»Ÿä¸€çš„ LLM API æ¥å£ï¼ˆKoboldAIã€Hordeã€NovelAIã€OpenAIã€Claude ç­‰ï¼‰
- è§’è‰²ç®¡ç†ç³»ç»Ÿ
- èŠå¤©å†å²ç®¡ç†
- WorldInfo (Lorebooks)
- æ‰©å±•ç³»ç»Ÿ

**æ‰©å±•æœºåˆ¶**:

1. **UI æ‰©å±•** (JavaScript):
```javascript
// è®¿é—® SillyTavern ä¸Šä¸‹æ–‡
const context = SillyTavern.getContext();
context.chat;           // èŠå¤©è®°å½•ï¼ˆå¯å˜ï¼‰
context.characters;     // è§’è‰²åˆ—è¡¨
context.characterId;    // å½“å‰è§’è‰²ç´¢å¼•
context.groups;         // ç¾¤ç»„åˆ—è¡¨
```

2. **æœåŠ¡å™¨æ’ä»¶** (Express Router):
```javascript
async function init(router) {
    // æ³¨å†Œè‡ªå®šä¹‰ API ç«¯ç‚¹
    router.post('/api/telegram/message', async (req, res) => {
        // å¤„ç† Telegram æ¶ˆæ¯
    });
}
```

### Python-Telegram-Bot

**åŸºæœ¬ä¿¡æ¯**:
- **ç±»å‹**: Telegram Bot API åŒ…è£…å™¨
- **è¯­è¨€**: Python 3.9+
- **ç‰ˆæœ¬**: v22.5
- **æ–‡æ¡£**: https://docs.python-telegram-bot.org/en/stable/

**æ ¸å¿ƒç‰¹æ€§**:
- å®Œå…¨å¼‚æ­¥
- æ”¯æŒ Webhook å’Œ Polling
- å†…è”é”®ç›˜æ”¯æŒ
- é”™è¯¯å¤„ç†æœºåˆ¶

**å®‰è£…**:
```bash
pip install python-telegram-bot
```

### Docker

**SillyTavern Docker é•œåƒ**:
```bash
docker pull ghcr.io/sillytavern/sillytavern:latest
```

---

## å®ç°æ–¹æ¡ˆ

### æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ¨èåº¦ |
|------|------|------|--------|
| **æ–¹æ¡ˆ A: æœåŠ¡å™¨æ’ä»¶ + Python Bot** | åŸç”Ÿé›†æˆï¼Œæ€§èƒ½å¥½ | éœ€è¦ç¼–å†™æ’ä»¶ | â­â­â­â­â­ |
| æ–¹æ¡ˆ B: UI æ‰©å±• + è½®è¯¢ | æ— éœ€ä¿®æ”¹åç«¯ | æ€§èƒ½è¾ƒå·®ï¼Œå»¶è¿Ÿé«˜ | â­â­â­ |
| æ–¹æ¡ˆ C: çº¯ WebSocket | å®æ—¶æ€§å¥½ | å®ç°å¤æ‚ | â­â­â­â­ |

### æ¨èæ–¹æ¡ˆï¼šæ–¹æ¡ˆ A

**æ¶æ„**:
1. SillyTavern æœåŠ¡å™¨æ’ä»¶æš´éœ² REST API
2. Python Telegram Bot è°ƒç”¨ SillyTavern API
3. é€šè¿‡ HTTP åŒå‘é€šä¿¡

**ä¼˜åŠ¿**:
- è§£è€¦è®¾è®¡ï¼Œæ˜“äºç»´æŠ¤
- æ”¯æŒæ°´å¹³æ‰©å±•
- è‰¯å¥½çš„é”™è¯¯å¤„ç†

---

## Docker éƒ¨ç½²

### docker-compose.yml

```yaml
version: '3.8'

services:
  sillytavern:
    image: ghcr.io/sillytavern/sillytavern:latest
    container_name: sillytavern
    hostname: sillytavern
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      - "./config:/home/node/app/config"
      - "./data:/home/node/app/data"
      - "./plugins:/home/node/app/plugins"
    environment:
      - ENABLE_SERVER_PLUGINS=true
    networks:
      - internal

  telegram-bot:
    build:
      context: ./telegram-bot
      dockerfile: Dockerfile
    container_name: telegram-bot
    restart: unless-stopped
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - SILLYTAVERN_URL=http://sillytavern:8000
      - ALLOWED_USER_ID=${ALLOWED_USER_ID}
    depends_on:
      - sillytavern
    networks:
      - internal

  nginx:
    image: nginx:alpine
    container_name: nginx-proxy
    restart: unless-stopped
    ports:
      - "443:443"
      - "80:80"
    volumes:
      - "./nginx/nginx.conf:/etc/nginx/nginx.conf:ro"
      - "./nginx/ssl:/etc/nginx/ssl:ro"
    depends_on:
      - sillytavern
      - telegram-bot
    networks:
      - internal

networks:
  internal:
    driver: bridge
```

### SillyTavern é…ç½®

**config.yaml**:
```yaml
enableServerPlugins: true
listen: false
port: 8000

# LLM API é…ç½®
main_api: 'openai'  # æˆ– 'claude', 'kobold' ç­‰

# OpenAI é…ç½®ç¤ºä¾‹
openai:
  api_key: ${OPENAI_API_KEY}
  model: gpt-4-turbo
```

---

## API æ¥å£è®¾è®¡

### SillyTavern æ’ä»¶ API

#### 1. å‘é€æ¶ˆæ¯

```
POST /api/telegram/send
```

**è¯·æ±‚ä½“**:
```json
{
  "characterId": 0,
  "message": "ä½ å¥½",
  "user": "TelegramUser"
}
```

**å“åº”**:
```json
{
  "success": true,
  "message": "AI å›å¤å†…å®¹",
  "messageId": "msg_123"
}
```

#### 2. è·å–è§’è‰²åˆ—è¡¨

```
GET /api/telegram/characters
```

**å“åº”**:
```json
{
  "characters": [
    {
      "id": 0,
      "name": "è‰¾è‰",
      "description": "ä¸€ä¸ªå‹å–„çš„ AI åŠ©æ‰‹"
    },
    {
      "id": 1,
      "name": "èµ›åšæœ‹å…‹ä¾¦æ¢",
      "description": "æœªæ¥çš„ä¾¦æ¢è§’è‰²"
    }
  ]
}
```

#### 3. åˆ‡æ¢è§’è‰²

```
POST /api/telegram/character/switch
```

**è¯·æ±‚ä½“**:
```json
{
  "characterId": 1
}
```

#### 4. è·å–å†å²è®°å½•

```
GET /api/telegram/history?limit=10
```

**å“åº”**:
```json
{
  "messages": [
    {
      "role": "user",
      "content": "ä½ å¥½",
      "timestamp": 1704096000000
    },
    {
      "role": "assistant",
      "content": "ä½ å¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ",
      "timestamp": 1704096005000
    }
  ]
}
```

---

## ä»£ç ç¤ºä¾‹

### SillyTavern æœåŠ¡å™¨æ’ä»¶

```javascript
// /home/node/app/plugins/telegram-integration/index.js
const express = require('express');
const router = express.Router();

// æ’ä»¶ä¿¡æ¯
module.exports.info = {
    id: 'telegram-integration',
    name: 'Telegram Integration',
    description: 'API endpoints for Telegram Bot integration'
};

// åˆå§‹åŒ–æ’ä»¶
module.exports.init = async function(serverRouter) {
    console.log('[Telegram Integration] Plugin loaded');

    // å‘é€æ¶ˆæ¯ç«¯ç‚¹
    serverRouter.post('/api/telegram/send', async (req, res) => {
        try {
            const { characterId, message, user } = req.body;

            // TODO: è°ƒç”¨ SillyTavern å†…éƒ¨ API å‘é€æ¶ˆæ¯
            // éœ€è¦è®¿é—® SillyTavern ä¸Šä¸‹æ–‡

            res.json({
                success: true,
                message: 'å›å¤å†…å®¹',
                messageId: generateId()
            });
        } catch (error) {
            console.error('[Telegram Integration] Error:', error);
            res.status(500).json({ success: false, error: error.message });
        }
    });

    // è·å–è§’è‰²åˆ—è¡¨
    serverRouter.get('/api/telegram/characters', (req, res) => {
        // TODO: ä» SillyTavern ä¸Šä¸‹æ–‡è·å–è§’è‰²åˆ—è¡¨
        res.json({
            characters: []
        });
    });

    // åˆ‡æ¢è§’è‰²
    serverRouter.post('/api/telegram/character/switch', async (req, res) => {
        const { characterId } = req.body;
        // TODO: åˆ‡æ¢è§’è‰²
        res.json({ success: true });
    });

    // è·å–å†å²è®°å½•
    serverRouter.get('/api/telegram/history', (req, res) => {
        const limit = parseInt(req.query.limit) || 10;
        // TODO: è·å–å†å²è®°å½•
        res.json({ messages: [] });
    });

    return Promise.resolve();
};

// æ¸…ç†æ’ä»¶
module.exports.exit = async function() {
    console.log('[Telegram Integration] Plugin unloaded');
    return Promise.resolve();
};

function generateId() {
    return 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}
```

### Python Telegram Bot

```python
# telegram-bot/bot.py
import os
import logging
import httpx
from typing import Dict, Any
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    CallbackQueryHandler,
    ContextTypes,
    filters
)

# é…ç½®
TELEGRAM_BOT_TOKEN = os.getenv('TELEGRAM_BOT_TOKEN')
SILLYTAVERN_URL = os.getenv('SILLYTAVERN_URL', 'http://sillytavern:8000')
ALLOWED_USER_ID = int(os.getenv('ALLOWED_USER_ID', '0'))

# æ—¥å¿—é…ç½®
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# HTTP å®¢æˆ·ç«¯
http_client = httpx.AsyncClient(timeout=60.0)


class SillyTavernClient:
    """SillyTavern API å®¢æˆ·ç«¯"""

    def __init__(self, base_url: str):
        self.base_url = base_url

    async def send_message(self, character_id: int, message: str, user: str) -> Dict[str, Any]:
        """å‘é€æ¶ˆæ¯åˆ° SillyTavern"""
        url = f"{self.base_url}/api/telegram/send"
        payload = {
            "characterId": character_id,
            "message": message,
            "user": user
        }
        response = await http_client.post(url, json=payload)
        response.raise_for_status()
        return response.json()

    async def get_characters(self) -> Dict[str, Any]:
        """è·å–è§’è‰²åˆ—è¡¨"""
        url = f"{self.base_url}/api/telegram/characters"
        response = await http_client.get(url)
        response.raise_for_status()
        return response.json()

    async def switch_character(self, character_id: int) -> Dict[str, Any]:
        """åˆ‡æ¢è§’è‰²"""
        url = f"{self.base_url}/api/telegram/character/switch"
        payload = {"characterId": character_id}
        response = await http_client.post(url, json=payload)
        response.raise_for_status()
        return response.json()

    async def get_history(self, limit: int = 10) -> Dict[str, Any]:
        """è·å–å†å²è®°å½•"""
        url = f"{self.base_url}/api/telegram/history?limit={limit}"
        response = await http_client.get(url)
        response.raise_for_status()
        return response.json()


# å…¨å±€å®¢æˆ·ç«¯
st_client = SillyTavernClient(SILLYTAVERN_URL)


def is_authorized(user_id: int) -> bool:
    """æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æˆæƒ"""
    return ALLOWED_USER_ID == 0 or user_id == ALLOWED_USER_ID


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """å¼€å§‹å‘½ä»¤"""
    if not is_authorized(update.effective_user.id):
        await update.message.reply_text("æŠ±æ­‰ï¼Œä½ æ²¡æœ‰æƒé™ä½¿ç”¨æ­¤æœºå™¨äººã€‚")
        return

    keyboard = [
        [InlineKeyboardButton("ğŸ’¬ å¼€å§‹èŠå¤©", callback_data="chat_start")],
        [InlineKeyboardButton("ğŸ‘¥ åˆ‡æ¢è§’è‰²", callback_data="character_list")],
        [InlineKeyboardButton("ğŸ“œ å†å²è®°å½•", callback_data="history_view")],
        [InlineKeyboardButton("âš™ï¸ è®¾ç½®", callback_data="settings_menu")],
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    await update.message.reply_text(
        "ğŸ¤– æ¬¢è¿ä½¿ç”¨ SillyTavern Telegram Botï¼\n\n"
        "é€‰æ‹©ä¸€ä¸ªæ“ä½œå¼€å§‹ï¼š",
        reply_markup=reply_markup
    )


async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """å¤„ç†ç”¨æˆ·æ¶ˆæ¯"""
    if not is_authorized(update.effective_user.id):
        return

    user_id = update.effective_user.id
    user_name = update.effective_user.first_name
    message = update.message.text

    # æ˜¾ç¤º"æ­£åœ¨è¾“å…¥"çŠ¶æ€
    await update.message.chat.send_action('typing')

    try:
        # è·å–å½“å‰è§’è‰² IDï¼ˆä»ä¸Šä¸‹æ–‡è·å–ï¼‰
        character_id = context.user_data.get('character_id', 0)

        # å‘é€åˆ° SillyTavern
        result = await st_client.send_message(character_id, message, user_name)

        if result.get('success'):
            # å‘é€ AI å›å¤
            await update.message.reply_text(result.get('message', 'AI å›å¤'))
        else:
            await update.message.reply_text("âŒ å‘é€æ¶ˆæ¯å¤±è´¥")
            logger.error(f"Send message failed: {result}")

    except httpx.HTTPError as e:
        await update.message.reply_text("âŒ è¿æ¥ SillyTavern å¤±è´¥")
        logger.error(f"HTTP error: {e}")
    except Exception as e:
        await update.message.reply_text("âŒ å‘ç”Ÿé”™è¯¯")
        logger.error(f"Error: {e}")


async def show_characters(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """æ˜¾ç¤ºè§’è‰²åˆ—è¡¨"""
    query = update.callback_query
    await query.answer()

    try:
        result = await st_client.get_characters()
        characters = result.get('characters', [])

        if not characters:
            await query.edit_message_text("æ²¡æœ‰å¯ç”¨çš„è§’è‰²")
            return

        # æ„å»ºè§’è‰²é€‰æ‹©é”®ç›˜
        keyboard = []
        for char in characters[:8]:  # æœ€å¤šæ˜¾ç¤º 8 ä¸ª
            keyboard.append([
                InlineKeyboardButton(
                    f"ğŸ­ {char.get('name', 'Unknown')}",
                    callback_data=f"char_select_{char.get('id', 0)}"
                )
            ])
        keyboard.append([InlineKeyboardButton("ğŸ”™ è¿”å›", callback_data="main_menu")])

        reply_markup = InlineKeyboardMarkup(keyboard)

        await query.edit_message_text(
            "é€‰æ‹©ä¸€ä¸ªè§’è‰²ï¼š",
            reply_markup=reply_markup
        )
    except Exception as e:
        await query.edit_message_text("âŒ è·å–è§’è‰²åˆ—è¡¨å¤±è´¥")
        logger.error(f"Error showing characters: {e}")


async def select_character(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """é€‰æ‹©è§’è‰²"""
    query = update.callback_query
    await query.answer()

    # è§£æè§’è‰² ID
    character_id = int(query.data.split('_')[-1])

    try:
        # åˆ‡æ¢è§’è‰²
        result = await st_client.switch_character(character_id)

        if result.get('success'):
            # ä¿å­˜åˆ°ç”¨æˆ·ä¸Šä¸‹æ–‡
            context.user_data['character_id'] = character_id
            await query.edit_message_text(f"âœ… è§’è‰²åˆ‡æ¢æˆåŠŸï¼ç°åœ¨å¯ä»¥å¼€å§‹èŠå¤©äº†ã€‚")
        else:
            await query.edit_message_text("âŒ è§’è‰²åˆ‡æ¢å¤±è´¥")

    except Exception as e:
        await query.edit_message_text("âŒ åˆ‡æ¢è§’è‰²æ—¶å‘ç”Ÿé”™è¯¯")
        logger.error(f"Error selecting character: {e}")


async def show_history(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """æ˜¾ç¤ºå†å²è®°å½•"""
    query = update.callback_query
    await query.answer()

    try:
        result = await st_client.get_history(limit=5)
        messages = result.get('messages', [])

        if not messages:
            await query.edit_message_text("æš‚æ— å†å²è®°å½•")
            return

        # æ„å»ºå†å²è®°å½•æ–‡æœ¬
        history_text = "ğŸ“œ æœ€è¿‘çš„æ¶ˆæ¯ï¼š\n\n"
        for msg in messages:
            role = "ğŸ‘¤ ç”¨æˆ·" if msg.get('role') == 'user' else "ğŸ¤– AI"
            content = msg.get('content', '')
            history_text += f"{role}: {content[:100]}...\n\n"

        keyboard = [[InlineKeyboardButton("ğŸ”™ è¿”å›", callback_data="main_menu")]]
        reply_markup = InlineKeyboardMarkup(keyboard)

        await query.edit_message_text(history_text, reply_markup=reply_markup)

    except Exception as e:
        await query.edit_message_text("âŒ è·å–å†å²è®°å½•å¤±è´¥")
        logger.error(f"Error showing history: {e}")


async def main_menu(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """è¿”å›ä¸»èœå•"""
    query = update.callback_query
    await query.answer()

    keyboard = [
        [InlineKeyboardButton("ğŸ’¬ å¼€å§‹èŠå¤©", callback_data="chat_start")],
        [InlineKeyboardButton("ğŸ‘¥ åˆ‡æ¢è§’è‰²", callback_data="character_list")],
        [InlineKeyboardButton("ğŸ“œ å†å²è®°å½•", callback_data="history_view")],
        [InlineKeyboardButton("âš™ï¸ è®¾ç½®", callback_data="settings_menu")],
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    await query.edit_message_text(
        "ğŸ¤– SillyTavern Telegram Bot\n\n"
        "é€‰æ‹©ä¸€ä¸ªæ“ä½œï¼š",
        reply_markup=reply_markup
    )


async def error_handler(update: object, context: ContextTypes.DEFAULT_TYPE) -> None:
    """é”™è¯¯å¤„ç†"""
    logger.error(f"Update {update} caused error {context.error}")


def main() -> None:
    """ä¸»å‡½æ•°"""
    # åˆ›å»ºåº”ç”¨
    application = Application.builder().token(TELEGRAM_BOT_TOKEN).build()

    # æ³¨å†Œå¤„ç†å™¨
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("help", start))
    application.add_handler(CallbackQueryHandler(show_characters, pattern="^character_list$"))
    application.add_handler(CallbackQueryHandler(select_character, pattern="^char_select_"))
    application.add_handler(CallbackQueryHandler(show_history, pattern="^history_view$"))
    application.add_handler(CallbackQueryHandler(main_menu, pattern="^main_menu$"))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

    # é”™è¯¯å¤„ç†å™¨
    application.add_error_handler(error_handler)

    # å¯åŠ¨ Webhook
    webhook_url = os.getenv('WEBHOOK_URL')
    port = int(os.getenv('PORT', '8443'))

    if webhook_url:
        logger.info(f"Starting webhook on port {port}")
        application.run_webhook(
            listen="0.0.0.0",
            port=port,
            url_path="webhook",
            webhook_url=f"{webhook_url}/webhook"
        )
    else:
        logger.info("Starting polling")
        application.run_polling()


if __name__ == '__main__':
    main()
```

### Dockerfile (Telegram Bot)

```dockerfile
# telegram-bot/Dockerfile
FROM python:3.11-slim

WORKDIR /app

# å®‰è£…ä¾èµ–
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶ä»£ç 
COPY bot.py .

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD python -c "import httpx; httpx.Client().get('http://localhost:8443/health')"

# å¯åŠ¨
CMD ["python", "bot.py"]
```

### requirements.txt

```
python-telegram-bot==22.5
httpx>=0.27.0,<0.29.0
```

---

## éƒ¨ç½²æµç¨‹

### 1. å‡†å¤‡ç¯å¢ƒ

```bash
# åˆ›å»ºé¡¹ç›®ç›®å½•
mkdir sillytavern-telegram
cd sillytavern-telegram

# åˆ›å»ºç›®å½•ç»“æ„
mkdir -p config data plugins telegram-bot nginx/ssl
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

```bash
# .env æ–‡ä»¶
TELEGRAM_BOT_TOKEN=your_bot_token_here
ALLOWED_USER_ID=123456789  # ä½ çš„ Telegram ç”¨æˆ· ID
OPENAI_API_KEY=your_openai_key_here
WEBHOOK_URL=https://your-domain.com
```

### 3. è·å– Telegram Bot Token

1. åœ¨ Telegram ä¸­æ‰¾åˆ° @BotFather
2. å‘é€ `/newbot` åˆ›å»ºæ–°æœºå™¨äºº
3. æŒ‰æç¤ºè®¾ç½®æœºå™¨äººåç§°
4. è·å– Bot Token

### 4. è·å–ç”¨æˆ· ID

1. åœ¨ Telegram ä¸­æ‰¾åˆ° @userinfobot
2. å‘é€ä»»æ„æ¶ˆæ¯è·å–ä½ çš„ç”¨æˆ· ID

### 5. å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f

# åœæ­¢æœåŠ¡
docker-compose down
```

### 6. è®¾ç½® Webhook

```bash
# è®¾ç½® Webhookï¼ˆæ›¿æ¢ YOUR_TOKEN å’Œ YOUR_URLï¼‰
curl -X POST "https://api.telegram.org/botYOUR_TOKEN/setWebhook" \
  -d "url=https://your-domain.com/webhook"
```

### 7. æµ‹è¯•

åœ¨ Telegram ä¸­æ‰¾åˆ°ä½ çš„æœºå™¨äººï¼Œå‘é€ `/start` å‘½ä»¤æµ‹è¯•ã€‚

---

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| Bot æ— å“åº” | Webhook æœªè®¾ç½® | æ£€æŸ¥ Webhook URL é…ç½® |
| è¿æ¥ SillyTavern å¤±è´¥ | å®¹å™¨ç½‘ç»œé—®é¢˜ | æ£€æŸ¥ docker-compose ç½‘ç»œé…ç½® |
| æ¶ˆæ¯å‘é€å¤±è´¥ | API ç«¯ç‚¹æœªå®ç° | æ£€æŸ¥æœåŠ¡å™¨æ’ä»¶æ˜¯å¦æ­£ç¡®åŠ è½½ |
| è§’è‰²åˆ—è¡¨ä¸ºç©º | SillyTavern æ²¡æœ‰è§’è‰² | åœ¨ SillyTavern ä¸­åˆ›å»ºè§’è‰² |
| æƒé™é”™è¯¯ | ALLOWED_USER_ID é”™è¯¯ | æ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½® |

### æ—¥å¿—æŸ¥çœ‹

```bash
# æŸ¥çœ‹ SillyTavern æ—¥å¿—
docker-compose logs sillytavern

# æŸ¥çœ‹ Telegram Bot æ—¥å¿—
docker-compose logs telegram-bot

# æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—
docker-compose logs -f
```

### è°ƒè¯•æ¨¡å¼

```yaml
# docker-compose.yml æ·»åŠ è°ƒè¯•é…ç½®
services:
  telegram-bot:
    environment:
      - LOG_LEVEL=DEBUG
```

---

## å‚è€ƒèµ„æ–™

### SillyTavern

- **GitHub ä»“åº“**: https://github.com/SillyTavern/SillyTavern
- **å®˜æ–¹æ–‡æ¡£**: https://docs.sillytavern.app/
- **æœåŠ¡å™¨æ’ä»¶å¼€å‘**: https://github.com/sillytavern/sillytavern-docs/blob/main/For_Contributors/Server-Plugins.md
- **UI æ‰©å±•å¼€å‘**: https://github.com/sillytavern/sillytavern-docs/blob/main/For_Contributors/Writing-Extensions.md

### Python-Telegram-Bot

- **å®˜æ–¹æ–‡æ¡£**: https://docs.python-telegram-bot.org/en/stable/
- **GitHub ä»“åº“**: https://github.com/python-telegram-bot/python-telegram-bot
- **ç¤ºä¾‹ä»£ç **: https://docs.python-telegram-bot.org/en/stable/examples.html

### Telegram Bot API

- **å®˜æ–¹æ–‡æ¡£**: https://core.telegram.org/bots/api
- **Webhook æŒ‡å—**: https://core.telegram.org/bots/api#setwebhook

### Docker

- **Docker Compose æ–‡æ¡£**: https://docs.docker.com/compose/
- **SillyTavern Docker é•œåƒ**: ghcr.io/sillytavern/sillytavern:latest

---

## é™„å½•

### A. å®Œæ•´ç›®å½•ç»“æ„

```
sillytavern-telegram/
â”œâ”€â”€ .env                          # ç¯å¢ƒå˜é‡
â”œâ”€â”€ docker-compose.yml            # Docker Compose é…ç½®
â”œâ”€â”€ config/                       # SillyTavern é…ç½®ç›®å½•
â”‚   â””â”€â”€ config.yaml              # SillyTavern é…ç½®æ–‡ä»¶
â”œâ”€â”€ data/                         # SillyTavern æ•°æ®ç›®å½•
â”‚   â”œâ”€â”€ characters/              # è§’è‰²æ•°æ®
â”‚   â””â”€â”€ chats/                   # èŠå¤©è®°å½•
â”œâ”€â”€ plugins/                      # SillyTavern æ’ä»¶ç›®å½•
â”‚   â””â”€â”€ telegram-integration/    # Telegram é›†æˆæ’ä»¶
â”‚       â”œâ”€â”€ index.js             # æ’ä»¶å…¥å£
â”‚       â””â”€â”€ package.json         # æ’ä»¶ä¾èµ–
â”œâ”€â”€ telegram-bot/                 # Telegram Bot ä»£ç 
â”‚   â”œâ”€â”€ bot.py                   # Bot ä¸»ç¨‹åº
â”‚   â”œâ”€â”€ Dockerfile               # Bot Docker é…ç½®
â”‚   â””â”€â”€ requirements.txt         # Python ä¾èµ–
â””â”€â”€ nginx/                        # Nginx é…ç½®
    â”œâ”€â”€ nginx.conf               # Nginx ä¸»é…ç½®
    â””â”€â”€ ssl/                     # SSL è¯ä¹¦ç›®å½•
```

### B. å®‰å…¨æ–¹æ¡ˆï¼šDocker ç½‘ç»œéš”ç¦»

#### å®‰å…¨é£é™©åˆ†æ

**SillyTavern è®¤è¯ç°çŠ¶**ï¼š
- SillyTavern é»˜è®¤**æ²¡æœ‰å†…ç½®çš„å¯†ç è®¤è¯ç³»ç»Ÿ**
- è®¾è®¡ä¸ºæœ¬åœ°ä½¿ç”¨ï¼Œå‡è®¾è¿è¡Œåœ¨å—ä¿¡ä»»çš„ç½‘ç»œç¯å¢ƒä¸­

| é£é™©åœºæ™¯ | æè¿° | é£é™©ç­‰çº§ |
|---------|------|---------|
| å…¬ç½‘æš´éœ² | ç›´æ¥æš´éœ² SillyTavern ç«¯å£åˆ°äº’è”ç½‘ | ğŸ”´ é«˜ |
| å†…ç½‘è®¿é—® | ä»…åœ¨ Docker ç½‘ç»œå†…è®¿é—® | ğŸŸ¢ ä½ |
| ä»£ç†è®¿é—® | é€šè¿‡ Nginx/Traefik åå‘ä»£ç† | ğŸŸ¡ ä¸­ |

#### æ¨èæ–¹æ¡ˆï¼šDocker ç½‘ç»œéš”ç¦»ï¼ˆæœ€ç®€å•ï¼‰

**æ¶æ„**ï¼šSillyTavern å’Œ Telegram Bot åœ¨åŒä¸€ Docker ç½‘ç»œï¼Œä¸æš´éœ² SillyTavern ç«¯å£åˆ°å¤–ç½‘

```yaml
# docker-compose.ymlï¼ˆå®‰å…¨é…ç½®ç‰ˆï¼‰
version: '3.8'

services:
  sillytavern:
    image: ghcr.io/sillytavern/sillytavern:latest
    container_name: sillytavern
    hostname: sillytavern
    restart: unless-stopped
    # ä¸æš´éœ²ç«¯å£åˆ°ä¸»æœº
    # ports:
    #   - "8000:8000"  # åˆ é™¤æˆ–æ³¨é‡Šè¿™è¡Œ
    volumes:
      - "./config:/home/node/app/config"
      - "./data:/home/node/app/data"
      - "./plugins:/home/node/app/plugins"
    environment:
      - ENABLE_SERVER_PLUGINS=true
    networks:
      - internal

  telegram-bot:
    build:
      context: ./telegram-bot
      dockerfile: Dockerfile
    container_name: telegram-bot
    restart: unless-stopped
    # åªæš´éœ² webhook ç«¯å£ç»™å¤–ç½‘
    ports:
      - "8443:8443"
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - SILLYTAVERN_URL=http://sillytavern:8000  # é€šè¿‡å®¹å™¨åè®¿é—®
      - ALLOWED_USER_ID=${ALLOWED_USER_ID}
      - WEBHOOK_URL=https://your-domain.com
    depends_on:
      - sillytavern
    networks:
      - internal

networks:
  internal:
    driver: bridge
```

**ä¼˜åŠ¿**ï¼š
- âœ… SillyTavern å®Œå…¨ä¸æš´éœ²åˆ°å¤–ç½‘
- âœ… åªæœ‰ Telegram Bot å¯ä»¥è®¿é—®
- âœ… æ— éœ€é¢å¤–è®¤è¯é…ç½®
- âœ… å®æ–½ç®€å•ï¼Œæ— éœ€ä¿®æ”¹ SillyTavern æºç 

**å·¥ä½œåŸç†**ï¼š
```
å¤–éƒ¨ç½‘ç»œ
    â”‚
    â”‚ åªæœ‰ Bot Webhook ç«¯å£ (8443)
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Docker ç½‘ç»œ (internal)          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Telegram Bot â”‚â”€â”€â”€â”€â”€â”€â–ºâ”‚ SillyTavern  â”‚ â”‚
â”‚  â”‚  (8443)      â”‚ HTTP â”‚  (8000)      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å…¶ä»–å®‰å…¨å»ºè®®

1. **ç”¨æˆ·è®¤è¯**: åªå…è®¸æˆæƒç”¨æˆ·è®¿é—® Botï¼ˆé€šè¿‡ `ALLOWED_USER_ID`ï¼‰
2. **HTTPS**: ç¡®ä¿ Webhook ä½¿ç”¨ SSL/TLS åŠ å¯†
3. **API å¯†é’¥ä¿æŠ¤**: ä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç å¯†é’¥ï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡
4. **å®šæœŸæ›´æ–°**: ä¿æŒ Docker é•œåƒå’Œä¾èµ–æ›´æ–°
5. **é˜²ç«å¢™è§„åˆ™**: åªå¼€æ”¾å¿…è¦çš„ç«¯å£ï¼ˆ8443 for Webhookï¼‰

### D. è®¿é—® SillyTavern Web UIï¼šCloudflare éš§é“æ–¹æ¡ˆ

#### é—®é¢˜è¯´æ˜

ä½¿ç”¨ Docker ç½‘ç»œéš”ç¦»åï¼ŒSillyTavern çš„ç«¯å£ 8000 ä¸æš´éœ²åˆ°å¤–ç½‘ï¼Œç”¨æˆ·æ— æ³•ç›´æ¥è®¿é—® Web UI è¿›è¡Œè®¾ç½®ï¼ˆå¦‚åˆ›å»ºè§’è‰²ã€é…ç½®é¢„è®¾ç­‰ï¼‰ã€‚

#### è§£å†³æ–¹æ¡ˆï¼šCloudflare éš§é“

é€šè¿‡ Cloudflare éš§é“ä¸´æ—¶æš´éœ² SillyTavern çš„ Web UIï¼Œä»…åœ¨éœ€è¦è®¾ç½®æ—¶å¼€å¯ï¼Œè®¾ç½®å®Œæˆåå…³é—­ã€‚

**æ¶æ„**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         äº‘æœåŠ¡å™¨                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚         Docker ç½‘ç»œ (internal)                              â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚ â”‚
â”‚  â”‚  â”‚ Telegram Bot â”‚â”€â”€â”€â”€â”€â”€â–ºâ”‚ SillyTavern  â”‚                     â”‚ â”‚
â”‚  â”‚  â”‚  (8443)      â”‚ HTTP â”‚  (8000)      â”‚                     â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚ â”‚
â”‚  â”‚                               â”‚                              â”‚ â”‚
â”‚  â”‚                               â”‚ Cloudflare Tunnel (ä¸´æ—¶)      â”‚ â”‚
â”‚  â”‚                               â–¼                              â”‚ â”‚
â”‚  â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚ â”‚
â”‚  â”‚                        â”‚ Cloudflare   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚ â”‚
â”‚  â”‚                        â”‚  éš§é“å…¥å£    â”‚    HTTPS     â”‚         â”‚ â”‚
â”‚  â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚         â”‚ â”‚
â”‚  â”‚                                                   â”‚         â”‚ â”‚
â”‚  â”‚                                                   â–¼         â”‚ â”‚
â”‚  â”‚                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚                                              â”‚  ç”¨æˆ·    â”‚ â”‚ â”‚
â”‚  â”‚                                              â”‚  è®¾ç½®æ—¶  â”‚ â”‚ â”‚
â”‚  â”‚                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ä½¿ç”¨æ­¥éª¤

**1. å®‰è£… Cloudflare Tunnel**

```bash
# ä¸‹è½½ cloudflared
curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
chmod +x cloudflared
sudo mv cloudflared /usr/local/bin/

# ç™»å½• Cloudflare
cloudflared tunnel login
```

**2. åˆ›å»ºéš§é“**

```bash
# åˆ›å»ºéš§é“
cloudflared tunnel create sillytavern-ui

# è®°å½•è¿”å›çš„ Tunnel ID
```

**3. åˆ›å»ºé…ç½®æ–‡ä»¶**

```bash
# åˆ›å»º ~/.cloudflared/config.yml
nano ~/.cloudflared/config.yml
```

```yaml
tunnel: <ä½ çš„éš§é“ID>
credentials-file: /root/.cloudflared/<ä½ çš„éš§é“ID>.json

ingress:
  - hostname: sillytavern.yourdomain.com  # ä½ çš„åŸŸå
    service: http://localhost:8000
  - service: http_status:404
```

**4. å¯åŠ¨éš§é“ï¼ˆéœ€è¦è®¾ç½®æ—¶ï¼‰**

```bash
# æ–¹å¼ 1ï¼šå‰å°è¿è¡Œï¼ˆæµ‹è¯•ç”¨ï¼‰
cloudflared tunnel run --config ~/.cloudflared/config.yml sillytavern-ui

# æ–¹å¼ 2ï¼šåå°è¿è¡Œ
nohup cloudflared tunnel run --config ~/.cloudflared/config.yml sillytavern-ui > tunnel.log 2>&1 &

# æ–¹å¼ 3ï¼šä½¿ç”¨ systemdï¼ˆæ¨èï¼‰
sudo nano /etc/systemd/system/cloudflared-sillytavern.service
```

```ini
[Unit]
Description=Cloudflare Tunnel for SillyTavern UI
After=network.target

[Service]
Type=simple
User=root
ExecStart=/usr/local/bin/cloudflared tunnel run --config /root/.cloudflared/config.yml sillytavern-ui
Restart=on-failure
RestartSec=5s

[Install]
WantedBy=multi-user.target
```

```bash
# å¯ç”¨å¹¶å¯åŠ¨æœåŠ¡
sudo systemctl daemon-reload
sudo systemctl enable cloudflared-sillytavern
sudo systemctl start cloudflared-sillytavern

# åœæ­¢æœåŠ¡ï¼ˆè®¾ç½®å®Œæˆåï¼‰
sudo systemctl stop cloudflared-sillytavern
sudo systemctl disable cloudflared-sillytavern  # ç¦æ­¢å¼€æœºè‡ªå¯
```

**5. è®¿é—® Web UI**

å¯åŠ¨éš§é“åï¼Œé€šè¿‡æµè§ˆå™¨è®¿é—®ï¼š
```
https://sillytavern.yourdomain.com
```

#### å®‰å…¨å»ºè®®

1. **ä»…åœ¨ä½¿ç”¨æ—¶å¼€å¯éš§é“**ï¼šè®¾ç½®å®Œæˆåç«‹å³å…³é—­
2. **ä½¿ç”¨å¼ºå¯†ç åŸŸå**ï¼šé¿å…åŸŸåè¢«çŒœæµ‹åˆ°
3. **å®šæœŸæ£€æŸ¥éš§é“çŠ¶æ€**ï¼šç¡®ä¿éš§é“æ²¡æœ‰è¢«æ»¥ç”¨
4. **ç›‘æ§è®¿é—®æ—¥å¿—**ï¼šè®°å½•è°è®¿é—®äº† Web UI

#### ä¼˜ç¼ºç‚¹

| ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|
| âœ… å®‰å…¨ï¼šSillyTavern å¹³æ—¶ä¸æš´éœ² | âŒ éœ€è¦æ‰‹åŠ¨å¼€å¯/å…³é—­éš§é“ |
| âœ… å…è´¹ï¼šCloudflare Tunnel å…è´¹ç‰ˆè¶³å¤Ÿä½¿ç”¨ | âŒ éœ€è¦é¢å¤–å®‰è£… cloudflared |
| âœ… HTTPSï¼šè‡ªåŠ¨æä¾› SSL è¯ä¹¦ | âŒ è®¾ç½®æ—¶éœ€è¦ç­‰å¾…éš§é“å¯åŠ¨ |
| âœ… çµæ´»ï¼šæŒ‰éœ€æš´éœ² | âŒ éœ€è¦è®°ä½åŸŸå |

---

**æ–‡æ¡£ç»“æŸ**