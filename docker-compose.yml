services:
  sillytavern:
    image: ghcr.io/sillytavern/sillytavern:latest
    container_name: sillytavern
    hostname: sillytavern
    restart: unless-stopped
    # 安全配置：不暴露端口到外网，只在 Docker 内部网络访问
    # 如需本地访问 Web UI，取消下行注释
    # ports:
    #   - "8000:8000"
    volumes:
      - "./config:/home/node/app/config"
      - "./data:/home/node/app/data"
      - "./plugins:/home/node/app/plugins"
    environment:
      - ENABLE_SERVER_PLUGINS=true
      # LLM API 配置（用于 Telegram 集成插件）
      - LLM_API_URL=${LLM_API_URL:-https://api.openai.com/v1}
      - LLM_API_KEY=${LLM_API_KEY}
      - LLM_MODEL=${LLM_MODEL:-gpt-4o-mini}
      - LLM_MAX_TOKENS=${LLM_MAX_TOKENS:-1024}
      - LLM_TEMPERATURE=${LLM_TEMPERATURE:-0.8}
      - PRESET_NAME=${PRESET_NAME:-Default}
      # TTS（语音消息）：可选，默认复用 LLM_API_*；模型/voice 需自行设置
      - TTS_API_URL=${TTS_API_URL:-}
      - TTS_API_KEY=${TTS_API_KEY:-}
      - TTS_MODEL=${TTS_MODEL:-}
      - TTS_VOICE=${TTS_VOICE:-}
      - TTS_FORMAT=${TTS_FORMAT:-opus}
    # 启动时自动安装插件依赖
    command: >
      sh -c "npm install --prefix /home/node/app/plugins/telegram-integration && node server.js"
    networks:
      - internal

  telegram-bot:
    build:
      context: ./telegram-bot
      dockerfile: Dockerfile
    container_name: telegram-bot
    restart: unless-stopped
    volumes:
      - "./data/telegram-bot:/app/data"
    # Webhook 模式才需要暴露端口，Polling 模式不需要
    # ports:
    #   - "8443:8443"
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - SILLYTAVERN_URL=http://sillytavern:8000
      - ALLOWED_USER_ID=${ALLOWED_USER_ID}
      - WEBHOOK_URL=${WEBHOOK_URL}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - TG_AUTH_DB_PATH=${TG_AUTH_DB_PATH:-/app/data/auth.json}
      - TG_REGISTRATION_ENABLED=${TG_REGISTRATION_ENABLED:-1}
      - TG_CONCURRENT_UPDATES=${TG_CONCURRENT_UPDATES:-8}
      - TG_CONNECTION_POOL_SIZE=${TG_CONNECTION_POOL_SIZE:-64}
      - TG_POOL_TIMEOUT=${TG_POOL_TIMEOUT:-30}
      - TELEGRAM_STREAM_RESPONSES=${TELEGRAM_STREAM_RESPONSES:-1}
      - TELEGRAM_STREAM_EDIT_INTERVAL_MS=${TELEGRAM_STREAM_EDIT_INTERVAL_MS:-750}
      - TELEGRAM_TYPING_INTERVAL_MS=${TELEGRAM_TYPING_INTERVAL_MS:-3500}
      - TELEGRAM_STREAM_PLACEHOLDER=${TELEGRAM_STREAM_PLACEHOLDER:-输入中...}
      - TG_TTS_MAX_CHARS=${TG_TTS_MAX_CHARS:-1500}
      - TG_TTS_CHOICES=${TG_TTS_CHOICES:-zh-CN-XiaoxiaoNeural=晓晓,zh-CN-YunxiNeural=云希,zh-CN-YunjianNeural=云健,zh-CN-XiaoyiNeural=晓伊,zh-CN-YunyangNeural=云扬,zh-CN-XiaochenNeural=晓辰,zh-CN-XiaochenMultilingualNeural=晓辰 多语言,zh-CN-XiaohanNeural=晓涵,zh-CN-XiaomengNeural=晓梦,zh-CN-XiaomoNeural=晓墨,zh-CN-XiaoqiuNeural=晓秋,zh-CN-XiaorouNeural=晓柔,zh-CN-XiaoruiNeural=晓睿,zh-CN-XiaoshuangNeural=晓双,zh-CN-XiaoxiaoDialectsNeural=晓晓 方言,zh-CN-XiaoxiaoMultilingualNeural=晓晓 多语言,zh-CN-XiaoyanNeural=晓颜,zh-CN-XiaoyouNeural=晓悠,zh-CN-XiaoyuMultilingualNeural=晓宇 多语言,zh-CN-XiaozhenNeural=晓甄,zh-CN-YunfengNeural=云枫,zh-CN-YunhaoNeural=云皓,zh-CN-YunjieNeural=云杰,zh-CN-YunxiaNeural=云夏,zh-CN-YunyeNeural=云野,zh-CN-YunyiMultilingualNeural=云逸 多语言,zh-CN-YunzeNeural=云泽,zh-CN-YunfanMultilingualNeural=Yunfan Multilingual,zh-CN-YunxiaoMultilingualNeural=Yunxiao Multilingual}
      - TTS_PROVIDER=${TTS_PROVIDER:-edge}
      - EDGE_TTS_DEFAULT_VOICE=${EDGE_TTS_DEFAULT_VOICE:-zh-CN-XiaoxiaoMultilingualNeural}
      - EDGE_TTS_DEFAULT_STYLE=${EDGE_TTS_DEFAULT_STYLE:-general}
      - EDGE_TTS_DEFAULT_RATE=${EDGE_TTS_DEFAULT_RATE:-0}
      - EDGE_TTS_DEFAULT_PITCH=${EDGE_TTS_DEFAULT_PITCH:-0}
      - EDGE_TTS_OUTPUT_FORMAT=${EDGE_TTS_OUTPUT_FORMAT:-ogg-24khz-16bit-mono-opus}
      # SillyTavern Basic Auth（与 config.yaml 中的密码一致）
      - ST_AUTH_USER=${ST_AUTH_USER:-}
      - ST_AUTH_PASS=${ST_AUTH_PASS:-}
    depends_on:
      - sillytavern
    networks:
      - internal

  # 可选：Nginx 反向代理（用于 HTTPS）
  # nginx:
  #   image: nginx:alpine
  #   container_name: nginx-proxy
  #   restart: unless-stopped
  #   ports:
  #     - "443:443"
  #     - "80:80"
  #   volumes:
  #     - "./nginx/nginx.conf:/etc/nginx/nginx.conf:ro"
  #     - "./nginx/ssl:/etc/nginx/ssl:ro"
  #   depends_on:
  #     - sillytavern
  #     - telegram-bot
  #   networks:
  #     - internal

networks:
  internal:
    driver: bridge
